<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Lorena Store</title>
    <script src="https://kit.fontawesome.com/4a3b1f73a2.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="js/simple-users.js"></script>
    <script src="js/auth.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', sans-serif; background: linear-gradient(135deg, #e75480, #ff6b9d); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: 2rem 1rem; }
        .profile-card { background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .profile-header { text-align: center; margin-bottom: 2rem; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #e75480, #ff6b9d); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 3rem; color: white; }
        .profile-name { font-size: 2rem; color: #333; margin-bottom: 0.5rem; }
        .profile-email { color: #666; font-size: 1.1rem; }
        .profile-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .stat-card { background: #f8f9fa; padding: 1.5rem; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #e75480; }
        .stat-label { color: #666; margin-top: 0.5rem; }
        .profile-section { margin: 2rem 0; }
        .section-title { font-size: 1.3rem; color: #333; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .order-item { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .order-date { color: #666; font-size: 0.9rem; }
        .order-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .btn { background: #e75480; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; text-decoration: none; display: inline-block; }
        .btn:hover { background: #d63384; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .actions { display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; }
        .edit-form { display: none; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #333; }
        .form-group input { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile-card">
            <div class="profile-header">
                <div class="profile-avatar" id="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-name" id="userName">Loading...</div>
                <div class="profile-email" id="userEmail">Loading...</div>
            </div>

            <div class="profile-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">Total Orders</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSpent">₦0</div>
                    <div class="stat-label">Total Spent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="memberSince">2024</div>
                    <div class="stat-label">Member Since</div>
                </div>
            </div>

            <div class="profile-section">
                <h3 class="section-title">
                    <i class="fas fa-shopping-bag"></i>
                    Recent Orders
                </h3>
                <div id="recentOrders">
                    <div class="order-item">
                        <div>
                            <div>No orders yet</div>
                            <div class="order-date">Start shopping to see your orders here</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3 class="section-title">
                    <i class="fas fa-user-edit"></i>
                    Account Settings
                </h3>
                <div id="profileInfo">
                    <div class="form-group">
                        <label>Full Name</label>
                        <div id="displayName">Loading...</div>
                    </div>
                    <div class="form-group">
                        <label>Email/Phone</label>
                        <div id="displayEmail">Loading...</div>
                    </div>
                    <div class="form-group">
                        <label>Member Since</label>
                        <div id="displayDate">Loading...</div>
                    </div>
                </div>

                <div class="edit-form" id="editForm">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="editName" placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label>Email/Phone</label>
                        <input type="text" id="editEmail" placeholder="Enter email or phone" readonly>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn" onclick="toggleEdit()" id="editBtn">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Back to Store
                </a>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </div>

    <script>
        let isEditing = false;
        let currentUser = null;

        // Load user profile on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
        });

        function loadUserProfile() {
            currentUser = AuthManager.checkAuth();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            // Display user info
            const userName = currentUser.name || 'User';
            const userEmail = currentUser.email || currentUser.phone || currentUser.id || 'No contact info';
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = userEmail;
            document.getElementById('displayName').textContent = userName;
            document.getElementById('displayEmail').textContent = userEmail;
            document.getElementById('editName').value = userName;
            document.getElementById('editEmail').value = userEmail;

            // Set avatar initial
            const initial = userName.charAt(0).toUpperCase();
            document.getElementById('avatar').innerHTML = initial;

            // Display member since
            const memberSince = currentUser.createdAt ? new Date(currentUser.createdAt).getFullYear() : new Date().getFullYear();
            document.getElementById('memberSince').textContent = memberSince;
            document.getElementById('displayDate').textContent = new Date(currentUser.createdAt || Date.now()).toLocaleDateString();

            // Load orders
            loadUserOrders();
        }

        function loadUserOrders() {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const userOrders = orders.filter(order => 
                order.customer?.email === currentUser.email || 
                order.customer?.phone === currentUser.phone ||
                order.userId === (currentUser.email || currentUser.phone)
            );

            document.getElementById('totalOrders').textContent = userOrders.length;
            
            const totalSpent = userOrders.reduce((sum, order) => {
                return sum + (order.total || 0);
            }, 0);
            document.getElementById('totalSpent').textContent = '₦' + totalSpent.toLocaleString();

            // Display recent orders
            const recentOrdersContainer = document.getElementById('recentOrders');
            if (userOrders.length === 0) {
                recentOrdersContainer.innerHTML = `
                    <div class="order-item">
                        <div>
                            <div>No orders yet</div>
                            <div class="order-date">Start shopping to see your orders here</div>
                        </div>
                        <a href="index.html" class="btn">Shop Now</a>
                    </div>
                `;
            } else {
                recentOrdersContainer.innerHTML = userOrders.slice(-5).reverse().map(order => `
                    <div class="order-item">
                        <div>
                            <div>Order #${order.orderNumber || 'N/A'}</div>
                            <div class="order-date">${new Date(order.orderDate || Date.now()).toLocaleDateString()}</div>
                        </div>
                        <div>
                            <div class="order-status status-completed">Completed</div>
                            <div style="margin-top: 0.5rem; font-weight: bold;">₦${(order.total || 0).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleEdit() {
            isEditing = !isEditing;
            const profileInfo = document.getElementById('profileInfo');
            const editForm = document.getElementById('editForm');
            const editBtn = document.getElementById('editBtn');

            if (isEditing) {
                profileInfo.style.display = 'none';
                editForm.style.display = 'block';
                editBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            } else {
                // Save changes
                const newName = document.getElementById('editName').value;
                if (newName.trim()) {
                    currentUser.name = newName.trim();
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Update in registered users
                    const users = JSON.parse(localStorage.getItem('registeredUsers') || '{}');
                    const userId = currentUser.email || currentUser.phone || currentUser.id;
                    if (users[userId]) {
                        users[userId].name = newName.trim();
                        localStorage.setItem('registeredUsers', JSON.stringify(users));
                    }
                    
                    loadUserProfile();
                }
                
                profileInfo.style.display = 'block';
                editForm.style.display = 'none';
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Profile';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isLoggedIn');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>