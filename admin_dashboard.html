<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Lorena Store</title>
    <script src="https://kit.fontawesome.com/4a3b1f73a2.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: #f5f7fa; color: #333; }
        .admin-header { background: linear-gradient(135deg, #e75480 0%, #ffb347 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .admin-header h1 { font-size: 2em; font-weight: 300; }
        .admin-header .user-info { float: right; margin-top: -40px; }
        .admin-nav { background: white; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .admin-nav button { background: none; border: none; padding: 10px 20px; margin-right: 10px; cursor: pointer; border-radius: 5px; transition: all 0.2s; }
        .admin-nav button:hover, .admin-nav button.active { background: #e75480; color: white; }
        .dashboard-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .stat-card i { font-size: 3em; margin-bottom: 15px; }
        .stat-card h3 { font-size: 2.5em; font-weight: 700; margin-bottom: 5px; }
        .stat-card p { color: #666; font-size: 1.1em; }
        .content-section { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; }
        .content-section.active { display: block; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .product-card { border: 1px solid #eee; border-radius: 8px; padding: 15px; text-align: center; transition: transform 0.2s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .product-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; }
        .product-card h4 { margin-bottom: 5px; color: #333; }
        .product-card .price { color: #e75480; font-weight: bold; font-size: 1.2em; }
        .product-actions { margin-top: 10px; }
        .product-actions button { margin: 2px; padding: 5px 10px; font-size: 0.9em; }
        .btn { background: #e75480; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background 0.2s; }
        .btn:hover { background: #d63384; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .orders-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .orders-table th, .orders-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .orders-table th { background: #f8f9fa; font-weight: 500; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #d1edff; color: #0c5460; }
        .logout-btn { position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        
        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .content-section {
            animation: fadeIn 0.3s ease;
        }
        
        .product-card {
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .btn {
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .stat-card {
            transition: transform 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #e75480;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            .admin-nav {
                overflow-x: auto;
                white-space: nowrap;
            }
            .admin-nav button {
                display: inline-block;
                margin-right: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-container {
                padding: 0 10px;
            }
        }
        
        /* Status badges */
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-shipped { background: #d4edda; color: #155724; }
        .status-delivered { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        /* Form improvements */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #e75480;
            box-shadow: 0 0 0 2px rgba(231, 84, 128, 0.2);
        }
        
        /* Table improvements */
        .orders-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Success/Error states */
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="admin-header">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center;">
                <a href="index.html" style="background: rgba(255,255,255,0.9); color: #e75480; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-right: 20px; font-size: 1em; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px;" title="Back to Website">
                    <i class="fas fa-arrow-left"></i> Back to Website
                </a>
                <h1><i class="fas fa-tachometer-alt"></i> Lorena Store Dashboard</h1>
            </div>
            <div class="user-info">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="serverStatus" style="display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                        <i class="fas fa-circle" id="statusIcon" style="color: #ffc107;"></i>
                        <span id="statusText">Checking...</span>
                    </div>
                    <span>Welcome, Admin</span>
                    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-nav">
        <button class="active" onclick="showSection('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
        <button onclick="showSection('products')"><i class="fas fa-box"></i> Products</button>
        <button onclick="showSection('orders')"><i class="fas fa-shopping-bag"></i> Orders</button>
        <button onclick="showSection('customers')"><i class="fas fa-users"></i> Customers</button>
    </div>

    <div class="dashboard-container">
        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-box" style="color: #e75480;"></i>
                    <h3 id="totalProducts">32</h3>
                    <p>Total Products</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-shopping-cart" style="color: #28a745;"></i>
                    <h3 id="totalOrders">0</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-naira-sign" style="color: #ffc107;"></i>
                    <h3 id="totalRevenue">₦0</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users" style="color: #17a2b8;"></i>
                    <h3 id="totalCustomers">0</h3>
                    <p>Customers</p>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Products Management</h2>
                <div>
                    <button class="btn" onclick="showAddProductForm()"><i class="fas fa-plus"></i> Add Product</button>
                    <button class="btn btn-secondary" onclick="refreshProducts()"><i class="fas fa-sync"></i> Refresh</button>
                    <button class="btn" style="background: #28a745;" onclick="exportProducts()"><i class="fas fa-download"></i> Export</button>
                </div>
            </div>
            
            <!-- Add/Edit Product Form -->
            <div id="productForm" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 id="formTitle">Add New Product</h3>
                <input type="hidden" id="editProductId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Product Name *</label>
                        <input type="text" id="productName" placeholder="Product Name" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Brand</label>
                        <input type="text" id="productBrand" placeholder="Brand" value="Lorena" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Price (₦) *</label>
                        <input type="number" id="productPrice" placeholder="Price" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Stock Quantity *</label>
                        <input type="number" id="productStock" placeholder="Stock" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Category *</label>
                        <select id="productCategory" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                            <option value="clothing">Clothing</option>
                            <option value="accessories">Accessories</option>
                            <option value="watches">Watches</option>
                            <option value="jewelry">Jewelry</option>
                            <option value="bags">Bags</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Main Image URL</label>
                        <input type="url" id="productImage" placeholder="Image URL" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Additional Images (comma-separated URLs)</label>
                        <input type="text" id="productPhotos" placeholder="URL1, URL2, URL3..." style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description *</label>
                        <textarea id="productDescription" placeholder="Product description..." rows="3" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 100%; resize: vertical;"></textarea>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="saveProduct()" id="saveBtn">Add Product</button>
                    <button class="btn btn-secondary" onclick="hideProductForm()">Cancel</button>
                </div>
            </div>
            
            <!-- Products Filter -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                <label style="font-weight: 500;">Filter by Category:</label>
                <select id="categoryFilter" onchange="filterProducts()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="all">All Categories</option>
                    <option value="clothing">Clothing</option>
                    <option value="accessories">Accessories</option>
                    <option value="watches">Watches</option>
                    <option value="jewelry">Jewelry</option>
                    <option value="bags">Bags</option>
                </select>
                <input type="text" id="searchProducts" placeholder="Search products..." onkeyup="searchProducts()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-left: 20px; width: 200px;">
            </div>
            
            <div id="productsGrid" class="products-grid">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Orders Management</h2>
                <div>
                    <select id="orderStatusFilter" onchange="filterOrders()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px;">
                        <option value="all">All Orders</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadOrders()"><i class="fas fa-sync"></i> Refresh</button>
                    <button class="btn" style="background: #17a2b8;" onclick="checkLocalOrders()"><i class="fas fa-search"></i> Check Local Orders</button>
                    <button class="btn" style="background: #28a745;" onclick="exportOrders()"><i class="fas fa-download"></i> Export</button>
                </div>
            </div>
            <div style="overflow-x: auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Customer</th>
                            <th>Contact</th>
                            <th>Date</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #666; padding: 40px;">Loading orders...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Customer Management</h2>
                <button class="btn btn-secondary" onclick="loadCustomers()"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            <div style="overflow-x: auto;">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>City</th>
                            <th>Total Orders</th>
                            <th>Total Spent</th>
                            <th>Last Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: #666; padding: 40px;">Loading customers...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Check admin authentication
        if(localStorage.getItem('isAdmin') !== 'true') {
            window.location.href = 'admin.html';
        }

        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.admin-nav button').forEach(b => b.classList.remove('active'));
            
            // Show selected section
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            if(section === 'products') loadProducts();
            if(section === 'orders') loadOrders();
            if(section === 'customers') loadCustomers();
            if(section === 'dashboard') updateDashboardStats();
        }

        let allProducts = [];
        
        function loadProducts() {
            fetch('/api/products')
                .then(res => res.json())
                .then(products => {
                    allProducts = products;
                    displayProducts(products);
                    document.getElementById('totalProducts').textContent = products.length;
                })
                .catch(err => {
                    document.getElementById('productsGrid').innerHTML = '<p style="text-align: center; color: #666;">Failed to load products. Make sure the server is running on port 4000.</p>';
                });
        }
        
        function displayProducts(products) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';
            
            if (products.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">No products found.</p>';
                return;
            }
            
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.preview}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/200x150?text=No+Image'">
                    <h4 title="${product.name}">${product.name.length > 20 ? product.name.substring(0, 20) + '...' : product.name}</h4>
                    <p class="price">₦${product.price.toLocaleString()}</p>
                    <p style="color: ${product.stock < 10 ? '#dc3545' : '#28a745'}; font-weight: 500;">Stock: ${product.stock}</p>
                    <p style="font-size: 0.9em; color: #666; text-transform: capitalize;">${product.category}</p>
                    <p style="font-size: 0.8em; color: #999;">${product.brand}</p>
                    <div class="product-actions">
                        <button class="btn" style="font-size: 0.8em; padding: 5px 8px; background: #17a2b8;" onclick="viewProduct('${product.id}')">View</button>
                        <button class="btn" style="font-size: 0.8em; padding: 5px 8px;" onclick="editProduct('${product.id}')">Edit</button>
                        <button class="btn" style="background: #dc3545; font-size: 0.8em; padding: 5px 8px;" onclick="deleteProduct('${product.id}')">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function refreshProducts() {
            showNotification('Refreshing products...', 'info');
            loadProducts();
        }

        function logout() {
            localStorage.removeItem('isAdmin');
            window.location.href = 'admin.html';
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        function showAddProductForm() {
            document.getElementById('formTitle').textContent = 'Add New Product';
            document.getElementById('saveBtn').textContent = 'Add Product';
            document.getElementById('editProductId').value = '';
            clearProductForm();
            document.getElementById('productForm').style.display = 'block';
        }
        
        function showEditProductForm(product) {
            document.getElementById('formTitle').textContent = 'Edit Product';
            document.getElementById('saveBtn').textContent = 'Update Product';
            document.getElementById('editProductId').value = product.id;
            
            // Fill form with product data
            document.getElementById('productName').value = product.name;
            document.getElementById('productBrand').value = product.brand || 'Lorena';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productImage').value = product.preview;
            document.getElementById('productPhotos').value = product.photos ? product.photos.join(', ') : '';
            document.getElementById('productDescription').value = product.description;
            
            document.getElementById('productForm').style.display = 'block';
        }

        function hideProductForm() {
            document.getElementById('productForm').style.display = 'none';
            clearProductForm();
        }
        
        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productBrand').value = 'Lorena';
            document.getElementById('productPrice').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productCategory').value = 'clothing';
            document.getElementById('productImage').value = '';
            document.getElementById('productPhotos').value = '';
            document.getElementById('productDescription').value = '';
        }

        function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const brand = document.getElementById('productBrand').value.trim() || 'Lorena';
            const price = parseInt(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value);
            const category = document.getElementById('productCategory').value;
            const image = document.getElementById('productImage').value.trim();
            const photosInput = document.getElementById('productPhotos').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const editId = document.getElementById('editProductId').value;

            if (!name || !price || !stock || !description) {
                alert('Please fill all required fields (Name, Price, Stock, Description)');
                return;
            }
            
            if (price <= 0 || stock < 0) {
                alert('Price must be greater than 0 and stock cannot be negative');
                return;
            }

            const photos = photosInput ? photosInput.split(',').map(url => url.trim()).filter(url => url) : [];
            const preview = image || 'https://via.placeholder.com/400x300?text=No+Image';
            if (image && !photos.includes(image)) {
                photos.unshift(image);
            }
            if (photos.length === 0) {
                photos.push(preview);
            }

            const productData = {
                name,
                brand,
                price,
                stock,
                preview,
                photos,
                description,
                isAccessory: category !== 'clothing',
                category
            };

            const url = editId ? `/api/products/${editId}` : '/api/products';
            const method = editId ? 'PUT' : 'POST';

            fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
            })
            .then(res => res.json())
            .then(() => {
                hideProductForm();
                loadProducts();
                alert(editId ? 'Product updated successfully!' : 'Product added successfully!');
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Failed to save product. Make sure server is running.');
            });
        }

        function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            fetch(`/api/products/${id}`, {
                method: 'DELETE'
            })
            .then(() => {
                loadProducts();
                alert('Product deleted successfully!');
            })
            .catch(err => alert('Failed to delete product.'));
        }

        function editProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (product) {
                showEditProductForm(product);
            }
        }
        
        function viewProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;
            
            const photosHtml = product.photos.map(photo => 
                `<img src="${photo}" style="width: 100px; height: 100px; object-fit: cover; margin: 5px; border-radius: 5px;" onerror="this.style.display='none'">`
            ).join('');
            
            const details = `
                <div style="max-width: 500px;">
                    <h3>${product.name}</h3>
                    <p><strong>Brand:</strong> ${product.brand}</p>
                    <p><strong>Price:</strong> ₦${product.price.toLocaleString()}</p>
                    <p><strong>Stock:</strong> ${product.stock}</p>
                    <p><strong>Category:</strong> ${product.category}</p>
                    <p><strong>Description:</strong> ${product.description}</p>
                    <div style="margin-top: 10px;">
                        <strong>Images:</strong><br>
                        ${photosHtml}
                    </div>
                </div>
            `;
            
            const popup = window.open('', '_blank', 'width=600,height=500,scrollbars=yes');
            popup.document.write(`
                <html>
                    <head><title>Product Details - ${product.name}</title></head>
                    <body style="font-family: Arial, sans-serif; padding: 20px;">
                        ${details}
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; background: #e75480; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                    </body>
                </html>
            `);
        }

        let allOrders = [];
        
        function loadOrders() {
            fetch('/api/orders')
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Server response not ok');
                    }
                    return res.json();
                })
                .then(orders => {
                    allOrders = orders;
                    displayOrders(orders);
                    updateDashboardStats();
                    console.log('Orders loaded successfully:', orders.length);
                })
                .catch(err => {
                    console.error('Failed to load orders:', err);
                    document.getElementById('ordersTableBody').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc3545; padding: 40px;"><i class="fas fa-exclamation-triangle"></i><br>Failed to load orders.<br><small>Make sure the backend server is running on port 4000</small></td></tr>';
                    showNotification('Failed to connect to server. Please ensure the backend is running.', 'error');
                });
        }
        
        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            if(orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            orders.reverse().forEach(order => {
                const row = document.createElement('tr');
                const itemsCount = order.items.length;
                const itemsText = itemsCount === 1 ? '1 item' : `${itemsCount} items`;
                
                row.innerHTML = `
                    <td><strong>${order.orderNumber}</strong></td>
                    <td>
                        <div>${order.customer.name}</div>
                        <small style="color: #666;">${order.customer.email}</small>
                    </td>
                    <td>
                        <div>${order.customer.phone}</div>
                        <small style="color: #666;">${order.customer.city}</small>
                    </td>
                    <td>
                        <div>${new Date(order.orderDate).toLocaleDateString()}</div>
                        <small style="color: #666;">${new Date(order.orderDate).toLocaleTimeString()}</small>
                    </td>
                    <td><span style="color: #666;">${itemsText}</span></td>
                    <td><strong>₦${order.totalAmount.toLocaleString()}</strong></td>
                    <td>
                        <select onchange="updateOrderStatus('${order.id}', this.value)" style="padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 0.85em;">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn" style="font-size: 0.8em; padding: 5px 8px;" onclick="viewOrderDetails('${order.id}')">View</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function filterOrders() {
            const status = document.getElementById('orderStatusFilter').value;
            let filtered = allOrders;
            
            if (status !== 'all') {
                filtered = allOrders.filter(order => order.status === status);
            }
            
            displayOrders(filtered);
        }
        
        function updateOrderStatus(orderId, newStatus) {
            fetch(`/api/orders/${orderId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(res => res.json())
            .then(() => {
                // Update local order status
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = newStatus;
                }
                // Show success message
                showNotification('Order status updated successfully!', 'success');
            })
            .catch(err => {
                showNotification('Failed to update order status', 'error');
                loadOrders(); // Reload to reset the dropdown
            });
        }
        
        function exportOrders() {
            const dataStr = JSON.stringify(allOrders, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'lorena-orders-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if(!order) return;
            
            const itemsHtml = order.items.map(item => `
                <tr>
                    <td><img src="${item.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'"></td>
                    <td>${item.name}</td>
                    <td>₦${item.price.toLocaleString()}</td>
                    <td>${item.quantity}</td>
                    <td><strong>₦${item.total.toLocaleString()}</strong></td>
                </tr>
            `).join('');
            
            const orderDetailsHtml = `
                <div style="max-width: 800px; font-family: Arial, sans-serif;">
                    <h2>Order Details - ${order.orderNumber}</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div>
                            <h3>Customer Information</h3>
                            <p><strong>Name:</strong> ${order.customer.name}</p>
                            <p><strong>Email:</strong> ${order.customer.email}</p>
                            <p><strong>Phone:</strong> ${order.customer.phone}</p>
                            <p><strong>City:</strong> ${order.customer.city}</p>
                            <p><strong>Address:</strong> ${order.customer.address}</p>
                        </div>
                        <div>
                            <h3>Order Information</h3>
                            <p><strong>Order Number:</strong> ${order.orderNumber}</p>
                            <p><strong>Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                            <p><strong>Status:</strong> <span style="text-transform: capitalize; color: #e75480;">${order.status}</span></p>
                            <p><strong>Total Amount:</strong> <span style="color: #28a745; font-size: 1.2em;">₦${order.totalAmount.toLocaleString()}</span></p>
                        </div>
                    </div>
                    
                    <h3>Order Items</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #ddd;">Image</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Product</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Price</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Quantity</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <h3>Grand Total: ₦${order.totalAmount.toLocaleString()}</h3>
                    </div>
                </div>
            `;
            
            const popup = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
            popup.document.write(`
                <html>
                    <head>
                        <title>Order Details - ${order.orderNumber}</title>
                        <style>
                            body { padding: 20px; font-family: Arial, sans-serif; }
                            table { border-collapse: collapse; }
                            th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                            th { background-color: #f8f9fa; }
                            .no-print { margin-top: 20px; }
                            @media print { .no-print { display: none; } }
                        </style>
                    </head>
                    <body>
                        ${orderDetailsHtml}
                        <div class="no-print">
                            <button onclick="window.print()" style="padding: 10px 20px; background: #e75480; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Print</button>
                            <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                        </div>
                    </body>
                </html>
            `);
        }
        
        function loadCustomers() {
            if (allOrders.length === 0) {
                document.getElementById('customersTableBody').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666; padding: 40px;">No customers yet</td></tr>';
                return;
            }
            
            // Group orders by customer email
            const customerMap = {};
            allOrders.forEach(order => {
                const email = order.customer.email;
                if (!customerMap[email]) {
                    customerMap[email] = {
                        ...order.customer,
                        orders: [],
                        totalSpent: 0
                    };
                }
                customerMap[email].orders.push(order);
                customerMap[email].totalSpent += order.totalAmount;
            });
            
            const customers = Object.values(customerMap);
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            customers.forEach(customer => {
                const lastOrder = customer.orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate))[0];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.city}</td>
                    <td><span style="color: #e75480; font-weight: 500;">${customer.orders.length}</span></td>
                    <td><strong>₦${customer.totalSpent.toLocaleString()}</strong></td>
                    <td>${new Date(lastOrder.orderDate).toLocaleDateString()}</td>
                    <td>
                        <button class="btn" style="font-size: 0.8em; padding: 5px 8px;" onclick="viewCustomerDetails('${customer.email}')">View Orders</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('totalCustomers').textContent = customers.length;
        }
        
        function viewCustomerDetails(email) {
            const customerOrders = allOrders.filter(order => order.customer.email === email);
            if (customerOrders.length === 0) return;
            
            const customer = customerOrders[0].customer;
            const ordersHtml = customerOrders.map(order => `
                <tr>
                    <td>${order.orderNumber}</td>
                    <td>${new Date(order.orderDate).toLocaleDateString()}</td>
                    <td>${order.items.length} items</td>
                    <td>₦${order.totalAmount.toLocaleString()}</td>
                    <td style="text-transform: capitalize;">${order.status}</td>
                </tr>
            `).join('');
            
            const totalSpent = customerOrders.reduce((sum, order) => sum + order.totalAmount, 0);
            
            const customerDetailsHtml = `
                <div style="max-width: 700px; font-family: Arial, sans-serif;">
                    <h2>Customer Details</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <h3>${customer.name}</h3>
                        <p><strong>Email:</strong> ${customer.email}</p>
                        <p><strong>Phone:</strong> ${customer.phone}</p>
                        <p><strong>City:</strong> ${customer.city}</p>
                        <p><strong>Address:</strong> ${customer.address}</p>
                        <p><strong>Total Orders:</strong> ${customerOrders.length}</p>
                        <p><strong>Total Spent:</strong> <span style="color: #28a745; font-size: 1.2em;">₦${totalSpent.toLocaleString()}</span></p>
                    </div>
                    
                    <h3>Order History</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #ddd;">Order #</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Date</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Items</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Total</th>
                                <th style="padding: 10px; border: 1px solid #ddd;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ordersHtml}
                        </tbody>
                    </table>
                </div>
            `;
            
            const popup = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            popup.document.write(`
                <html>
                    <head>
                        <title>Customer Details - ${customer.name}</title>
                        <style>
                            body { padding: 20px; font-family: Arial, sans-serif; }
                            table { border-collapse: collapse; }
                            th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                            th { background-color: #f8f9fa; }
                        </style>
                    </head>
                    <body>
                        ${customerDetailsHtml}
                        <div style="margin-top: 20px;">
                            <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                        </div>
                    </body>
                </html>
            `);
        }
        
        function updateDashboardStats() {
            fetch('/api/dashboard/stats')
                .then(res => res.json())
                .then(stats => {
                    document.getElementById('totalProducts').textContent = stats.totalProducts;
                    document.getElementById('totalOrders').textContent = stats.totalOrders;
                    document.getElementById('totalRevenue').textContent = '₦' + stats.totalRevenue.toLocaleString();
                    document.getElementById('totalCustomers').textContent = stats.totalCustomers;
                })
                .catch(err => console.error('Failed to load dashboard stats:', err));
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function filterProducts() {
            const category = document.getElementById('categoryFilter').value;
            const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
            
            let filtered = allProducts;
            
            if (category !== 'all') {
                filtered = filtered.filter(p => p.category === category);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.brand.toLowerCase().includes(searchTerm) ||
                    p.description.toLowerCase().includes(searchTerm)
                );
            }
            
            displayProducts(filtered);
        }
        
        function searchProducts() {
            filterProducts();
        }
        
        function exportProducts() {
            const dataStr = JSON.stringify(allProducts, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'lorena-products-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // Auto-refresh data every 30 seconds
        setInterval(() => {
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                switch(activeSection.id) {
                    case 'products':
                        loadProducts();
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                    case 'customers':
                        loadCustomers();
                        break;
                    case 'dashboard':
                        updateDashboardStats();
                        break;
                }
            }
        }, 30000);
        
        // Add loading states
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div><p style="margin-top: 10px; color: #666;">Loading...</p></div>';
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        showSection('dashboard');
                        break;
                    case '2':
                        e.preventDefault();
                        showSection('products');
                        break;
                    case '3':
                        e.preventDefault();
                        showSection('orders');
                        break;
                    case '4':
                        e.preventDefault();
                        showSection('customers');
                        break;
                }
            }
        });
        
        // Add tooltips
        function addTooltips() {
            const buttons = document.querySelectorAll('button[title]');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', (e) => {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = e.target.getAttribute('title');
                    tooltip.style.cssText = `
                        position: absolute;
                        background: #333;
                        color: white;
                        padding: 5px 10px;
                        border-radius: 4px;
                        font-size: 12px;
                        z-index: 1000;
                        pointer-events: none;
                        top: ${e.pageY - 35}px;
                        left: ${e.pageX - 50}px;
                    `;
                    document.body.appendChild(tooltip);
                    
                    button.addEventListener('mouseleave', () => {
                        tooltip.remove();
                    }, { once: true });
                });
            });
        }
        
        // Initialize tooltips after page load
        setTimeout(addTooltips, 1000);
        
        // Load initial data with loading states
        showLoading('productsGrid');
        showLoading('ordersTableBody');
        
        loadProducts();
        loadOrders();
        updateDashboardStats();
        
        // Show welcome message and check server connection
        setTimeout(() => {
            showNotification('Welcome to Lorena Store Admin Dashboard!', 'success');
            checkServerConnection();
        }, 1000);
        
        // Function to check server connection
        function checkServerConnection() {
            fetch('/api/health')
                .then(res => res.json())
                .then(data => {
                    console.log('✅ Server connection successful:', data);
                    showNotification('Server connected successfully!', 'success');
                })
                .catch(err => {
                    console.error('❌ Server connection failed:', err);
                    showNotification('⚠️ Backend server not running. Please start the server to see orders.', 'error');
                    
                    // Show instructions
                    setTimeout(() => {
                        const instructions = `
                            To start the backend server:
                            1. Open terminal/command prompt
                            2. Navigate to: E-CommerceWebsite/Backend/
                            3. Run: npm start
                            4. Server should start on http://localhost:4000
                        `;
                        console.log(instructions);
                    }, 2000);
                });
        }
        
        // Function to check for locally stored orders
        function checkLocalOrders() {
            try {
                const backupOrders = JSON.parse(localStorage.getItem('backupOrders') || '[]');
                const regularOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                const allLocalOrders = [...backupOrders, ...regularOrders];
                
                if (allLocalOrders.length === 0) {
                    showNotification('No local orders found.', 'info');
                    return;
                }
                
                // Display local orders
                allOrders = allLocalOrders;
                displayOrders(allLocalOrders);
                showNotification(`Found ${allLocalOrders.length} local orders. These may not be synced with the server.`, 'warning');
                
                // Update stats
                const totalRevenue = allLocalOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
                const uniqueCustomers = new Set(allLocalOrders.map(o => o.customer?.email)).size;
                
                document.getElementById('totalOrders').textContent = allLocalOrders.length;
                document.getElementById('totalRevenue').textContent = '₦' + totalRevenue.toLocaleString();
                document.getElementById('totalCustomers').textContent = uniqueCustomers;
                
            } catch (error) {
                console.error('Error checking local orders:', error);
                showNotification('Error checking local orders.', 'error');
            }
        }
    </script>
</body>
</html>